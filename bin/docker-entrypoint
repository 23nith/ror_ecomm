#!/bin/bash -e

# Define the path to the PID file
PID_FILE="/rails/tmp/pids/server.pid"

# Check if the PID file exists
if [ -f "$PID_FILE" ]; then
  # If the SERVER_STARTED environment variable is set, it means the server has been started before
  echo "Server has been started before. Running start_server.sh..."
  
  if ps -p 7 > /dev/null; then
    echo "Killing process with PID 7"
    kill -9 7
    sleep 60
    echo "Running database preparation..."
    if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
      ./bin/rails db:prepare
      # Execute the specified command
      exec "${@}"
    fi
  fi

else
  # If the SERVER_STARTED environment variable is not set, it means this is the first start of the server
  echo "First start of the server. Running database preparation..."  

  # Run database preparation
  if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
    echo "Running database preparation..."
    ./bin/rails db:prepare
  fi


  # Execute the specified command
  exec "${@}"
fi



